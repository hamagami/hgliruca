<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="refresh" content="600">
  <title>在席・研修中ステータス</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
    }

    #chart {
      width: 100%;
      height: calc(100vh - 100px);
      padding-bottom: 30px; /* ✅ 下のラベルが切れないように */
    }
  </style>
</head>
<body>
  <h2 style="text-align:center;">在席・研修中のステータス</h2>
  <p id="datetime" style="text-align:center;"></p>
  <p style="text-align:left; padding: 0 10px;">
    チェックポイントはログ収集時刻の状態でカウントされています。ログ収集時刻の間にステイタスが複数更新されてもカウントされません。<br>
    8時間以上更新されない在席中、研修中は変更忘れとして遡ってカウントされません。継続する場合は、8時間に１度同じステイタスで更新してください。
  </p>

  <script>
    const now = new Date();
    const formatted = now.toLocaleString("ja-JP", { timeZone: "Asia/Tokyo" });
    document.getElementById("datetime").innerText = "集計日時：" + formatted;
  </script>

  <div id="chart"></div>

  <script>
    fetch("https://dl.dropbox.com/scl/fi/42ka2afjpquql6lc499nu/status_summary_by_status.json?rlkey=woz5mjw8ubedulwk4lb19ytg5&dl=1")
      .then(response => response.json())
      .then(data => {
        const filteredNames = Object.keys(data).filter(name => !/\((P|S)\)/.test(name));
        const sortedNames = filteredNames.sort((a, b) =>
          (data[b]["在席中"] || 0) - (data[a]["在席中"] || 0)
        );

        const zaisekiY = sortedNames.map(name => data[name]["在席中"] || 0);
        const kenshuY = sortedNames.map(name => data[name]["研修中"] || 0);

        const nameLabels = sortedNames;

        const tracesInitial = [
          {
            x: sortedNames,
            y: sortedNames.map(() => 0),
            name: "在席中",
            type: 'bar',
            text: sortedNames.map(() => ""),
            textposition: 'auto'
          },
          {
            x: sortedNames,
            y: sortedNames.map(() => 0),
            name: "研修中",
            type: 'bar',
            text: sortedNames.map(() => ""),
            textposition: 'auto'
          }
        ];

        const tracesStep1 = [
          {
            y: zaisekiY,
            text: nameLabels
          },
          {
            y: sortedNames.map(() => 0),
            text: sortedNames.map(() => "")
          }
        ];

        const tracesStep2 = [
          {
            y: zaisekiY,
            text: nameLabels
          },
          {
            y: kenshuY,
            text: nameLabels
          }
        ];

        const allY = sortedNames.map(name =>
          (data[name]["在席中"] || 0) + (data[name]["研修中"] || 0)
        );
        const maxY = Math.max(...allY);
        const adjustedMax = Math.ceil(maxY / 0.8);

        const layout = {
          barmode: 'stack',
          margin: { t: 20, b: 100, l: 40, r: 20 }, // ✅ 十分な下マージン
          xaxis: {
            title: '',
            automargin: true,
            tickangle: 0,
            showticklabels: false // ✅ ラベルは非表示、textで補う
          },
          yaxis: {
            title: 'チェックポイント数',
            range: [0, adjustedMax]
          },
          autosize: true
        };

        Plotly.newPlot('chart', tracesInitial, layout, { responsive: true }).then(() => {
          Plotly.animate('chart', {
            data: tracesStep1
          }, {
            transition: { duration: 800, easing: 'cubic-in-out' },
            frame: { duration: 800, redraw: true }
          });

          setTimeout(() => {
            Plotly.animate('chart', {
              data: tracesStep2
            }, {
              transition: { duration: 800, easing: 'cubic-in-out' },
              frame: { duration: 800, redraw: true }
            });
          }, 1000);
        });
      })
      .catch(error => {
        document.getElementById("chart").innerText = "データの読み込みに失敗しました: " + error;
      });
  </script>
</body>
</html>
